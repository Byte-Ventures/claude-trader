name: Semantic Release

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  release:
    # Skip if this is a release commit (prevents infinite loop)
    if: "!startsWith(github.event.head_commit.message, 'chore(release):')"
    runs-on: ubuntu-latest
    concurrency:
      group: semantic-release
      cancel-in-progress: false

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install semantic-release
        run: pip install python-semantic-release

      - name: Configure Git
        run: |
          git config user.name "claude[bot]"
          git config user.email "noreply@anthropic.com"

      - name: Calculate next version
        id: version
        run: |
          # Get next version without making changes
          OUTPUT=$(semantic-release version --print 2>&1) || true

          # Check if semantic-release says no release needed
          if echo "$OUTPUT" | grep -q "No release will be made"; then
            echo "has_release=false" >> $GITHUB_OUTPUT
            echo "No release needed - version already released"
            exit 0
          fi

          VERSION=$(echo "$OUTPUT" | grep -oP '^\d+\.\d+\.\d+$' | tail -1)
          if [ -n "$VERSION" ]; then
            echo "next=$VERSION" >> $GITHUB_OUTPUT
            echo "has_release=true" >> $GITHUB_OUTPUT
            echo "Next version: $VERSION"
          else
            echo "has_release=false" >> $GITHUB_OUTPUT
            echo "No release needed"
            # Log warning if output suggests there should have been a version
            if echo "$OUTPUT" | grep -q "bump"; then
              echo "::warning::Version parsing may have failed. Output: $OUTPUT"
            fi
          fi

      - name: Create release branch and PR
        if: steps.version.outputs.has_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.next }}"
          BRANCH="release/v${VERSION}"

          # Create release branch
          git checkout -b "$BRANCH"

          # Run semantic-release to update version files and commit
          # --no-push: don't push yet (we'll push the branch manually)
          # --no-tag: don't create tag yet (will be created after PR merge)
          # --no-vcs-release: don't create GitHub release yet
          semantic-release version --no-push --no-tag --no-vcs-release

          # Push the release branch
          git push origin "$BRANCH"

          # Create PR
          if ! PR_URL=$(gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "chore(release): ${VERSION}" \
            --body "## Automated Release v${VERSION}

          This PR was automatically created by semantic-release.

          **Changes:**
          - Version bump to ${VERSION}
          - Updated CHANGELOG.md

          Merge this PR to complete the release."); then
            echo "::error::Failed to create PR for release $VERSION"
            # Cleanup orphaned branch
            git push origin --delete "$BRANCH" 2>/dev/null || true
            exit 1
          fi

          echo "Created PR: $PR_URL"
          echo "::notice::Release PR created at $PR_URL"
