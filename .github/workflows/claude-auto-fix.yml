name: Claude Auto-Fix Issues

on:
  issues:
    types: [labeled]
  repository_dispatch:
    types: [auto-fix-issue]

jobs:
  auto-fix:
    # Note: repository_dispatch is filtered by types: [auto-fix-issue] above
    if: |
      (github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'auto-fix') ||
      github.event_name == 'repository_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    concurrency:
      group: fix-issue-${{ github.event.issue.number || github.event.client_payload.issue_number || github.run_id }}
      cancel-in-progress: false

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Verify collaborator permission
        if: github.event_name != 'repository_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            // Skip for repository_dispatch - only internal workflows can trigger it
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.actor
            });
            if (!['write', 'admin'].includes(permission.permission)) {
              core.setFailed('Only collaborators with write access can trigger auto-fix');
            }

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Get issue details
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            // Get issue number from event or dispatch payload
            const issueNumber = context.payload.issue?.number || context.payload.client_payload?.issue_number;
            if (!issueNumber) {
              core.setFailed('No issue number found in event');
              return;
            }

            // Fetch issue details
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            // For repository_dispatch, verify issue has 'post-mortem' label (security check)
            if (context.eventName === 'repository_dispatch') {
              const hasPostMortemLabel = issue.labels.some(l => l.name === 'post-mortem');
              if (!hasPostMortemLabel) {
                core.setFailed('Security: repository_dispatch can only auto-fix issues with post-mortem label');
                return;
              }
            }

            core.setOutput('number', issue.number);
            core.setOutput('title', issue.title);
            core.setOutput('body', issue.body || '');
            console.log('Processing issue #' + issue.number + ': ' + issue.title);

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Configure Git
        run: |
          git config user.name "claude[bot]"
          git config user.email "noreply@anthropic.com"

      - name: Create fix branch
        id: branch
        run: |
          BRANCH="fix/issue-${{ steps.issue.outputs.number }}"
          git checkout -B "$BRANCH"
          echo "name=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.title }}
          ISSUE_BODY: ${{ steps.issue.outputs.body }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Fix GitHub Issue #${{ steps.issue.outputs.number }}

            **Title:** ${{ steps.issue.outputs.title }}
            **Body:** ${{ steps.issue.outputs.body }}

            ## Context
            This is claude-trader, a cryptocurrency trading bot. Read CLAUDE.md first for project guidelines.

            ## Instructions
            1. Read CLAUDE.md to understand project conventions
            2. Analyze the issue and locate relevant code
            3. Implement the fix following CLAUDE.md guidelines
            4. Do NOT modify src/version.py (version bumps happen at merge time)
            5. Run tests: python3 -m pytest tests/ --ignore=tests/test_coinbase_integration_live.py -v
            6. Commit with message referencing issue #${{ steps.issue.outputs.number }}
            7. Push to origin/${{ steps.branch.outputs.name }}
            8. Create PR to develop with "Closes #${{ steps.issue.outputs.number }}" in body

            Do NOT auto-merge - PRs require human approval.
          claude_args: >-
            --model claude-opus-4-5-20251101
            --max-turns 100
            --allowed-tools "Read,Write,Edit,Glob,Grep,Bash(git:*),Bash(gh pr create:*),Bash(gh pr view:*),Bash(python3:*),Bash(pytest:*),Bash(pip:*)"

      - name: Comment on issue
        if: always()
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
        with:
          script: |
            const success = '${{ job.status }}' === 'success';
            const body = success
              ? `Auto-fix completed. Check the created PR.\n\n[Workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
              : `Auto-fix failed. [Check logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(process.env.ISSUE_NUMBER),
              body: body
            });

      - name: Update labels
        if: success()
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
        with:
          script: |
            const issue = parseInt(process.env.ISSUE_NUMBER);
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue,
              name: 'auto-fix'
            }).catch(() => {});
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue,
              labels: ['fix-in-progress']
            });

      - name: Cleanup branch on failure
        if: failure()
        run: |
          git push origin --delete "fix/issue-${{ steps.issue.outputs.number }}" 2>/dev/null || true
