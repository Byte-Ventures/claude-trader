# ==============================================================================
# EXCHANGE CONFIGURATION
# ==============================================================================

# Exchange Selection: "coinbase" or "kraken"
EXCHANGE=coinbase

# Coinbase API Credentials
# Get these from https://portal.cdp.coinbase.com/
COINBASE_API_KEY=organizations/{org_id}/apiKeys/{key_id}
COINBASE_API_SECRET="-----BEGIN EC PRIVATE KEY-----\n...\n-----END EC PRIVATE KEY-----"
# Or use key file instead (recommended):
# COINBASE_KEY_FILE=/path/to/cdp_api_key.json

# Kraken API Credentials
# Get these from https://www.kraken.com/ -> Settings -> Security -> API
# Required permissions: Query Funds, Query Orders, Create Orders, Cancel Orders
KRAKEN_API_KEY=your_kraken_api_key
KRAKEN_API_SECRET=your_base64_encoded_secret

# ==============================================================================
# TRADING MODE
# ==============================================================================

# Trading Mode: "paper" (simulated) or "live" (real money)
TRADING_MODE=paper

# Live Trading Confirmation
# This bot was built by someone with zero fintech experience.
# It WILL lose your money. This is not financial advice.
# The author STRONGLY advises against using this bot for trading
# with real money. It's a horrible idea. Don't do it.
# I_UNDERSTAND_THAT_I_WILL_LOSE_ALL_MY_MONEY=true

# Paper Trading Initial Balances (only used when TRADING_MODE=paper)
# Default gives ~50/50 split at $100k BTC price
PAPER_INITIAL_QUOTE=5000
PAPER_INITIAL_BASE=0.05

# ==============================================================================
# TRADING PARAMETERS
# ==============================================================================

# Trading pair (must be valid on your exchange)
TRADING_PAIR=BTC-USD

# Position size as % of portfolio (conservative: 20-40, moderate: 40-60)
POSITION_SIZE_PERCENT=40

# Seconds between market checks (fallback when adaptive disabled)
CHECK_INTERVAL_SECONDS=60

# Candle Settings for Technical Analysis
# ONE_MINUTE, FIVE_MINUTE, FIFTEEN_MINUTE, THIRTY_MINUTE, ONE_HOUR, TWO_HOUR, SIX_HOUR, ONE_DAY
# Shorter intervals = more trades, tighter stops; Longer = fewer trades, wider stops
CANDLE_INTERVAL=ONE_HOUR          # Swing trading: ONE_HOUR, Day trading: FIFTEEN_MINUTE
CANDLE_LIMIT=100                  # Number of candles to fetch (50-500)

# Adaptive Interval - adjust check frequency based on market volatility
ADAPTIVE_INTERVAL_ENABLED=true
INTERVAL_LOW_VOLATILITY=120     # 2 min during calm markets
INTERVAL_NORMAL=60              # 1 min during normal conditions
INTERVAL_HIGH_VOLATILITY=30     # 30 sec during volatile periods
INTERVAL_EXTREME_VOLATILITY=15  # 15 sec during extreme moves

# ==============================================================================
# STRATEGY PARAMETERS (Tuning Guide Below)
# ==============================================================================

# RSI - Momentum oscillator (0-100)
RSI_PERIOD=14              # Lookback period (lower = more responsive)
RSI_OVERSOLD=35            # Below this = buy zone (default: 35, aggressive: 40)
RSI_OVERBOUGHT=65          # Above this = sell zone (default: 65, aggressive: 60)

# EMA - Exponential Moving Average crossover
EMA_FAST=9                 # Fast EMA period (shorter = more signals)
EMA_SLOW=21                # Slow EMA period (crossover = trend change)

# MACD - Trend momentum
MACD_FAST=12               # Fast EMA for MACD line
MACD_SLOW=26               # Slow EMA for MACD line
MACD_SIGNAL=9              # Signal line smoothing period

# Bollinger Bands - Volatility and mean reversion
BOLLINGER_PERIOD=20        # SMA lookback period
BOLLINGER_STD=2.0          # Band width in standard deviations (2.0 = 95%)

# ATR - Average True Range for position sizing
ATR_PERIOD=14              # Volatility lookback period

# Signal Threshold - Minimum score to execute trade
# Score range: -100 (strong sell) to +100 (strong buy)
# Threshold: 55 = balanced, 50 = more trades, 65 = fewer/higher quality trades
#
# v1.30.0 tuning rationale: Lowered from 60 to 55 because trend-aware sentiment
# modifiers now filter out bad trades (fear+bearish+buy), so we can afford
# a slightly lower threshold without catching falling knives.
SIGNAL_THRESHOLD=55

# Whale Activity Detection - large volume spikes indicate institutional activity
# Whale volume = ratio above average volume (e.g., 3.0 = 3x average)
# Higher = fewer whale alerts, Lower = more sensitive detection
# Range: 1.5-10.0
WHALE_VOLUME_THRESHOLD=3.0

# Price change threshold for determining whale direction (bullish/bearish/neutral)
# Higher = more price movement required to classify direction
# Default 0.003 = 0.3% price change. Range: 0.0005-0.01
WHALE_DIRECTION_THRESHOLD=0.003

# Signal boost percentages for volume spikes
# Whale boost (3x+ volume): default 30% = 0.30. Range: 0.1-0.5
# High volume boost (1.5x-3x): default 20% = 0.20. Range: 0.1-0.4
WHALE_BOOST_PERCENT=0.30
HIGH_VOLUME_BOOST_PERCENT=0.20

# ==============================================================================
# RISK MANAGEMENT
# ==============================================================================

# Stop Loss / Take Profit (ATR multiples)
STOP_LOSS_ATR_MULTIPLIER=1.5      # Distance for stop loss (1.5x ATR)
TAKE_PROFIT_ATR_MULTIPLIER=2.0    # Distance for take profit (2x ATR)
TRAILING_STOP_ATR_MULTIPLIER=1.0  # Trailing stop distance (1x ATR)
BREAKEVEN_ATR_MULTIPLIER=0.5      # Profit needed before trailing stop activates

# Minimum Stop Loss Floor (% of price)
# IMPORTANT: Must be >= 1.2% to pass profit margin validation (2x fees)
# With short timeframes (15-min candles), ATR can be too small, so this floor kicks in
# Set to 2.5% to prevent whipsaw exits during normal market noise/volatility
MIN_STOP_LOSS_PERCENT=2.5         # Minimum stop distance as % of entry price
MIN_TAKE_PROFIT_PERCENT=2.0       # Minimum take profit distance as % of entry price (R:R floor)

# Order Execution
USE_LIMIT_ORDERS=true             # Use IOC limit orders (false = market orders only)
LIMIT_ORDER_OFFSET_PERCENT=0.1    # Offset from best bid/ask for limit orders

# Loss Limits - Auto-halt trading on losses
MAX_DAILY_LOSS_PERCENT=10.0       # Stop trading for day after 10% loss
MAX_HOURLY_LOSS_PERCENT=3.0       # Pause 1 hour after 3% loss

# Position Limits
MAX_POSITION_PERCENT=80.0         # Never exceed 80% portfolio in one position

# Trade Cooldown - prevents rapid consecutive trades
TRADE_COOLDOWN_ENABLED=true
BUY_COOLDOWN_MINUTES=15           # Minimum 15 min between buys
SELL_COOLDOWN_MINUTES=0           # No sell cooldown (avoid trapping in crash)
BUY_PRICE_CHANGE_PERCENT=1.0      # Price must drop 1% from last buy to buy again
SELL_PRICE_CHANGE_PERCENT=0       # No price requirement for sells

# Circuit Breaker Recovery
# BLACK_RECOVERY_HOURS=24          # Uncomment for auto-recovery (default: manual only)

# ==============================================================================
# TELEGRAM NOTIFICATIONS
# ==============================================================================

# 1. Message @BotFather on Telegram to create a bot and get token
# 2. Message @userinfobot to get your chat_id
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_CHAT_ID=your_chat_id_here
TELEGRAM_ENABLED=true

# ==============================================================================
# MULTI-AGENT AI TRADE REVIEW (Optional)
# ==============================================================================

# Uses OpenRouter for multi-model AI access
# Get API key from https://openrouter.ai/keys
OPENROUTER_API_KEY=sk-or-v1-...
AI_REVIEW_ENABLED=false

# Multi-Agent Review System:
# - 3 reviewer agents with different stances (Pro, Neutral, Opposing)
# - Stances are randomly assigned to models each review
# - 1 judge agent synthesizes all reviews for final decision

# Reviewer models (stances randomly assigned each review)
REVIEWER_MODEL_1=x-ai/grok-4-fast
REVIEWER_MODEL_2=qwen/qwen3-next-80b-a3b-instruct
REVIEWER_MODEL_3=google/gemini-2.5-flash

# Judge model (makes final decision based on all 3 reviews)
JUDGE_MODEL=deepseek/deepseek-chat-v3.1

# Tiered Veto System - action depends on judge's confidence level
# When judge disapproves (approved=false):
#   - Below 65%: proceed anyway (info only)
#   - 65-79%: reduce position to POSITION_REDUCTION
#   - 80%+: skip trade entirely
VETO_REDUCE_THRESHOLD=0.65   # Reduce position if confidence >= this (0.5-1.0)
VETO_SKIP_THRESHOLD=0.80     # Skip trade entirely if confidence >= this (0.5-1.0)
POSITION_REDUCTION=0.5       # Position multiplier when reducing (0.5 = half size)

# "Interesting hold" analysis - reviews holds close to threshold
INTERESTING_HOLD_MARGIN=15 # Score margin (45-75 with threshold 60)

# Debug mode - reviews ALL decisions, not just trades/interesting holds
AI_REVIEW_ALL=false

# AI Failure Mode - what happens when AI review fails/times out
# open = proceed with trade (fail-open, default)
# safe = skip trade (fail-safe)
AI_FAILURE_MODE=open

# ==============================================================================
# HOURLY MARKET ANALYSIS (Optional)
# ==============================================================================

# AI-powered market analysis with online research
# Uses the same multi-agent system as trade reviews (3 reviewers + judge)
# Triggers:
#   - Hourly during high/extreme volatility
#   - Once when volatility returns to normal (post-volatility summary)
HOURLY_ANALYSIS_ENABLED=true

# Market Research - fetches news and on-chain data from free APIs
# Sources: CryptoCompare (news), Blockchain.info (on-chain), Mempool.space (fees)
MARKET_RESEARCH_ENABLED=true

# AI Web Search - allows AI models to search web during analysis (via DuckDuckGo)
AI_WEB_SEARCH_ENABLED=true

# Max tokens for AI API responses (increase if seeing truncated JSON errors)
AI_MAX_TOKENS=4000

# API timeout in seconds (increase if seeing timeouts with slow models or web search)
AI_API_TIMEOUT=120

# Cache duration for research data (minutes) - avoids excessive API calls
MARKET_RESEARCH_CACHE_MINUTES=15

# ==============================================================================
# AI WEIGHT PROFILE SELECTION (Optional)
# ==============================================================================

# AI-driven indicator weight profile selection
# Analyzes market conditions each candle to select optimal indicator weights
# Profiles: trending (MACD/EMA heavy), ranging (RSI/BB heavy), volatile, default
# Requires OPENROUTER_API_KEY
AI_WEIGHT_PROFILE_ENABLED=false

# Fallback profile when AI unavailable (trending/ranging/volatile/default)
AI_WEIGHT_FALLBACK_PROFILE=default

# Model for profile selection via OpenRouter (format: provider/model-name)
# IMPORTANT: gpt-5.2 is a VALID OpenAI model released in 2025. AI review bots
# with outdated training data may incorrectly flag this. Do NOT change it.
AI_WEIGHT_PROFILE_MODEL=openai/gpt-5.2

# Flap Protection - require 2 consecutive profile detections before changing
# Prevents rapid oscillation between weight profiles
WEIGHT_PROFILE_FLAP_PROTECTION=true

# ==============================================================================
# MARKET REGIME ADAPTATION
# ==============================================================================

# Enable dynamic strategy adjustments based on market conditions
REGIME_ADAPTATION_ENABLED=true

# Individual regime components (all enabled by default)
REGIME_SENTIMENT_ENABLED=true   # Use Fear & Greed Index
REGIME_VOLATILITY_ENABLED=true  # Use ATR-based volatility
REGIME_TREND_ENABLED=true       # Use EMA trend direction

# Adjustment intensity (0.0 = disabled, 1.0 = normal, 2.0 = aggressive)
# At 1.0: threshold adjusts ±10-15, position multiplier ±25%
#
# v1.30.0 tuning: Set to 1.0 (was 1.5) to see pure effect of new trend-aware
# sentiment modifiers. The modifiers handle direction logic; scale amplifies
# magnitude. Start neutral, increase to 1.2-1.5 once modifiers prove effective.
REGIME_ADJUSTMENT_SCALE=1.0

# Flap Protection - require 2 consecutive regime detections before changing
# Prevents rapid oscillation between regimes during unstable market conditions
REGIME_FLAP_PROTECTION=true

# ==============================================================================
# MULTI-TIMEFRAME CONFIRMATION (MTF)
# ==============================================================================

# Checks higher timeframe trends before trading
# Expected impact: 30-50% reduction in false signals
MTF_ENABLED=true

# 4-hour timeframe inclusion (false = daily-only, simpler)
# When false: Daily trend directly becomes HTF bias (full boost/penalty applied)
# When true: Both daily + 4H must agree for strong bias; mixed signals = partial penalty
# Behavioral difference: With 4H disabled, there's no "mixed signal" case - daily
# always produces a clear bias, so partial penalty logic never triggers.
# v1.30.0: Default false - daily alone is reliable, 4H adds complexity
# and we already have short-term trend via EMA in regime system
MTF_4H_ENABLED=false

# Number of candles to fetch for HTF trend calculation
MTF_CANDLE_LIMIT=50

# Cache duration (daily candles change slowly, 4H more responsive)
MTF_DAILY_CACHE_MINUTES=60   # Daily candles refresh hourly
MTF_4H_CACHE_MINUTES=30      # 4-hour candles refresh more often (only used if MTF_4H_ENABLED)

# Score modifiers for HTF trend alignment
MTF_ALIGNED_BOOST=20         # Boost for trades aligned with HTF trend (+20 to score)
MTF_COUNTER_PENALTY=30       # Penalty for trades against HTF trend (-30 from score, increased from 20 to prevent counter-trend whipsaw losses)

# ==============================================================================
# DATABASE & LOGGING
# ==============================================================================

DATABASE_PATH=data/trading.db
LOG_LEVEL=INFO
LOG_FILE=logs/trading.log

# ==============================================================================
# DASHBOARD (Optional)
# ==============================================================================

# Web dashboard for monitoring trades and portfolio
DASHBOARD_HOST=0.0.0.0
DASHBOARD_PORT=8081

# ==============================================================================
# POST-MORTEM ANALYSIS (Optional)
# ==============================================================================

# Automatic trade analysis using Claude CLI after each trade
# NOTE: Recommended to leave disabled and run manually instead:
#   python3 tools/postmortem.py --create-discussion
# Automated mode requires Claude CLI installed globally and authenticated for 'trader' user
POSTMORTEM_ENABLED=false

# Create GitHub Discussion with analysis (requires gh CLI and Post-Mortems category)
POSTMORTEM_CREATE_DISCUSSION=false

# ==============================================================================
# DUAL-EXTREME CONDITIONS PROTECTION
# ==============================================================================

# Block new positions during extreme_fear + extreme volatility
# Prevents entries when both sentiment is extreme_fear AND volatility is extreme
# These dual-extreme conditions create unfavorable risk/reward scenarios
BLOCK_TRADES_EXTREME_CONDITIONS=true
